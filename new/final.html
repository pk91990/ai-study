<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Study Planner with Smart Rescheduler</title>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: #f3f6ff;
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 500px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    h2, h3 { text-align: center; }

    input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      background: #0058ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background: #003fcc;
    }

    .task {
      background: #eef2ff;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .incomplete {
      background: #ffebeb;
      border-left: 5px solid red;
    }

    .complete {
      background: #e8ffe8;
      border-left: 5px solid green;
      text-decoration: line-through;
    }

    #loader { text-align:center; margin:10px 0; display:none; font-weight:bold; }

  </style>
</head>
<body>

<div class="container">

  <h2>üìö AI Smart Planner</h2>

  <label>Subjects</label>
  <input type="text" id="subjects" placeholder="DSA, DBMS, OS">

  <label>Hours per day</label>
  <input type="number" id="hours" placeholder="3">

  <label>Exam Date</label>
  <input type="date" id="examDate">

  <button id="generateBtn">Generate Plan</button>

  <button id="recalcBtn" style="display:none; background:#ff9800;">Recalculate Missed Tasks</button>

  <div id="loader">‚è≥ Processing...</div>

  <h3>Your Study Plan</h3>
  <div id="taskList">No plan yet.</div>

</div>

<script>
const API_KEY = "AIzaSyA6JM8xH-B2R2OKT_UlEPTHChGsmDLvXZo";
const taskList = document.getElementById("taskList");
const recalcBtn = document.getElementById("recalcBtn");

let studyPlan = [];

document.getElementById("generateBtn").onclick = generatePlan;
recalcBtn.onclick = recalcPlan;

// ========= Gemini Request Handler (2.5 Flash Format) =========
async function geminiRequest(prompt) {
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          temperature: 0.2,
          responseMimeType: "application/json"
        }
      })
    }
  );

  const data = await response.json();

  let text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

  // Cleanup if Gemini wraps in code blocks
  text = text.replace(/```json|```/g, "").trim();

  return text;
}

// ========= Generate Initial Study Plan =========
async function generatePlan() {
  const subjects = document.getElementById("subjects").value.trim();
  const hours = document.getElementById("hours").value.trim();
  const examDate = document.getElementById("examDate").value.trim();

  if (!subjects || !hours || !examDate) {
    alert("Please fill all inputs.");
    return;
  }

  showLoader(true);

  const prompt = `
You are an AI Study Planner.

üõë IMPORTANT RULES:
- The plan MUST end on the exam date.
- Do NOT create more days than the total number of days available.
- If exam is in 30 days, plan must be exactly 30 days.
- Never extend beyond the exam date.

User Inputs:
Subjects: ${subjects}
Daily Hours: ${hours}
Exam Date: ${examDate}
Today's Date: ${new Date().toISOString().split("T")[0]}

Calculate number of days between today and exam.
Then distribute subjects evenly across those days.
Include revision in last 20% of days.

Return STRICT JSON ONLY (no text outside JSON):

[
 { "day": "Day 1", "date": "YYYY-MM-DD", "task": "Subject - Chapter/Topic", "status": "pending" }
]
`

  const result = await geminiRequest(prompt);
  console.log(result);
  

  try {
    studyPlan = JSON.parse(result);
    savePlan();
    displayPlan();
    recalcBtn.style.display = "block";
  } catch (err) {
    taskList.innerHTML = "‚ö† Invalid JSON from Gemini:<br><br>" + result;
  }

  showLoader(false);
}

// ========= Display Study Plan =========
function displayPlan() {
  if (!studyPlan.length) return taskList.innerHTML = "No plan yet.";

  taskList.innerHTML = "";

  studyPlan.forEach((task, i) => {
    const div = document.createElement("div");
    div.className =
      "task " +
      (task.status === "done"
        ? "complete"
        : task.status === "missed"
        ? "incomplete"
        : "");

    div.innerHTML = `
      <b>${task.day}</b>: ${task.task}
      <select onchange="updateStatus(${i}, this.value)">
        <option value="pending" ${task.status === "pending" ? "selected" : ""}>Pending</option>
        <option value="done" ${task.status === "done" ? "selected" : ""}>Done</option>
        <option value="missed" ${task.status === "missed" ? "selected" : ""}>Missed</option>
      </select>
    `;

    taskList.appendChild(div);
  });
}

// ========= Update Task Status =========
function updateStatus(index, status) {
  studyPlan[index].status = status;
  savePlan();
  displayPlan();
}

// ========= Save / Load Locally =========
function savePlan() {
  localStorage.setItem("studyPlan", JSON.stringify(studyPlan));
}

function loadPlan() {
  const data = localStorage.getItem("studyPlan");
  if (data) {
    studyPlan = JSON.parse(data);
    displayPlan();
  }
}
loadPlan();

// ========= Smart Rescheduler (AI) =========
async function recalcPlan() {
  showLoader(true);

  const missedTasks = studyPlan.filter(t => t.status === "missed").map(t => t.task);

  if (missedTasks.length === 0) {
    alert("No missed tasks.");
    showLoader(false);
    return;
  }

  const prompt = `
You are an advanced AI Smart Study Rescheduler.

Missed tasks:
${missedTasks.join(", ")}

Rules:
- Move missed tasks to later dates.
- Increase workload closer to the exam.
- Mark tasks repeated twice or more with: "risk": true
- Status must always reset to "pending".
- Output ONLY pure JSON array. No commentary.

Format:
[
  { "day": "Day X", "task": "____", "status": "pending", "risk": false }
]
`;

  const result = await geminiRequest(prompt);

  try {
    studyPlan = JSON.parse(result);
    savePlan();
    displayPlan();
  } catch {
    taskList.innerHTML = "‚ö† Error parsing recalc output:<br><br>" + result;
  }

  showLoader(false);
}

// ========= Loader UI =========
function showLoader(show) {
  document.getElementById("loader").style.display = show ? "block" : "none";
}
</script>



</body>
</html>
